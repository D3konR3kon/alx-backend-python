#!/usr/bin/env bash
# kubctl-0x03 - trigger rolling update by applying blue_deployment.yaml with updated image:2.0 and monitor rollout
set -euo pipefail

DEPLOYMENT="django-messaging-blue"

echo "Applying updated blue deployment (should reference image:2.0 in the file)..."
kubectl apply -f blue_deployment.yaml

echo "Monitoring rollout status..."
kubectl rollout status deployment/${DEPLOYMENT}

# Continuous curl test to check availability (runs in background)
SERVICE_URL="$(minikube service django-messaging-svc --url | sed -n '1p')"
if [ -n "$SERVICE_URL" ]; then
  echo "Starting a simple availability check to $SERVICE_URL (10 requests)"
  for i in {1..10}; do
    curl -s -o /dev/null -w "%{http_code}\n" "$SERVICE_URL" || echo "request failed"
    sleep 1
  done
else
  echo "Service URL not available. Use kubectl port-forward or adjust the test target."
fi

kubectl get pods -l app=django-messaging

echo "Rolling update script complete."